# GammaTool 实现指南

本文档提供 GammaTool 的实现路线图和关键技术要点，帮助开发者快速理解项目结构和实现思路。

## 实现路线图

### 阶段一：核心功能（优先级：高）

#### 1. Gamma 调节引擎 (`src/gamma_engine.py`)

**目标**：实现屏幕 Gamma 值的底层调节功能

**关键技术点**：
- 使用 Windows GDI32 API 的 `SetDeviceGammaRamp` 函数
- 定义 RAMP 结构体（256 个 RGB 值的数组）
- 实现 Gamma 计算算法（亮度、对比度、灰度、RGB 通道）
- 保存和恢复默认 Gamma 值

**核心方法**：
- `set_brightness(value)` - 设置亮度
- `set_contrast(value)` - 设置对比度
- `set_grayscale(value)` - 设置灰度
- `set_rgb(r, g, b)` - 设置 RGB 通道
- `apply_settings()` - 应用设置
- `reset_to_default()` - 恢复默认

#### 2. 配置管理器 (`src/config_manager.py`)

**目标**：管理用户配置的保存和加载

**关键技术点**：
- 使用 JSON 格式存储配置
- 配置文件位置：`%APPDATA%/GammaTool/config.json`
- 配置验证和默认值处理
- 支持嵌套配置的读写（如 `display.brightness`）

**核心方法**：
- `load_config()` - 加载配置
- `save_config()` - 保存配置
- `get(key, default)` - 获取配置值
- `set(key, value)` - 设置配置值

---

### 阶段二：用户界面（优先级：高）

#### 3. 主窗口界面 (`src/main_window.py`)

**目标**：创建直观易用的图形界面

**界面组件**：
- 亮度、对比度、灰度滑块（QSlider）
- RGB 三色通道滑块
- 数值显示标签（QLabel）
- 热键设置、恢复默认、最小化按钮（QPushButton）
- 分组框（QGroupBox）用于组织界面

**关键技术点**：
- 使用 QSS 样式表美化界面
- 实现防抖机制（QTimer）避免频繁调用 API
- 信号槽机制连接界面和引擎
- 窗口透明度和置顶设置

**样式文件**：
- `resources/styles/dark_theme.qss` - 深色主题
- `resources/styles/light_theme.qss` - 浅色主题

---

### 阶段三：扩展功能（优先级：中）

#### 4. 热键管理器 (`src/hotkey_manager.py`)

**目标**：实现全局热键功能

**关键技术点**：
- 使用 `keyboard` 库注册全局热键
- 热键格式：`ctrl+alt+up`
- 支持热键的注册、注销和冲突检测
- 热键设置对话框（QDialog）

**默认热键**：
- `Ctrl+Alt+Up` - 增加亮度
- `Ctrl+Alt+Down` - 降低亮度
- `Ctrl+Alt+R` - 恢复默认

#### 5. 系统托盘 (`src/tray_icon.py`)

**目标**：提供系统托盘图标和菜单

**关键技术点**：
- 使用 QSystemTrayIcon 创建托盘图标
- 右键菜单（QMenu）提供快捷操作
- 双击显示主窗口
- 气泡通知（showMessage）

**托盘菜单项**：
- 显示/隐藏主窗口
- 快速调节（子菜单）
- 恢复默认
- 开机自启动
- 退出程序

#### 6. 工具函数 (`src/utils.py`)

**目标**：提供通用工具函数

**主要功能**：
- `get_resource_path()` - 获取资源文件路径（支持打包后）
- `set_auto_start()` - 设置开机自启动（修改注册表）
- `setup_logging()` - 配置日志系统
- `clamp()` - 数值范围限制

---

### 阶段四：集成和优化（优先级：中）

#### 7. 主程序入口 (`src/main.py`)

**目标**：整合所有模块，启动应用程序

**主要职责**：
- 初始化所有组件
- 连接信号和槽
- 加载配置并应用
- 注册热键
- 处理程序退出

**启动流程**：
```
1. 创建 QApplication
2. 初始化日志系统
3. 创建配置管理器
4. 创建 Gamma 引擎
5. 创建热键管理器
6. 创建主窗口
7. 创建系统托盘
8. 加载配置
9. 注册热键
10. 显示界面/托盘
```

---

### 阶段五：资源和打包（优先级：低）

#### 8. 资源文件

**图标资源** (`resources/icons/`)：
- `app_icon.ico` - 应用程序图标（256x256）
- `tray_icon.png` - 托盘图标（32x32）

**样式文件** (`resources/styles/`)：
- `dark_theme.qss` - 深色主题样式
- `light_theme.qss` - 浅色主题样式

#### 9. 打包配置

**PyInstaller 配置** (`build.spec`)：
- 单文件打包模式
- 包含资源文件
- 排除不必要的模块
- 使用 UPX 压缩
- 设置应用图标

**打包命令**：
```bash
pyinstaller build.spec
```

---

## 技术难点和解决方案

### 1. Gamma 值计算

**难点**：如何将亮度、对比度、灰度、RGB 通道综合计算

**解决方案**：
- 使用归一化值（0.0-1.0）进行计算
- 按顺序应用：对比度 → 亮度 → 灰度 → RGB
- 最后转换为 16 位整数（0-65535）

### 2. 防抖处理

**难点**：滑块拖动时频繁调用 API 导致卡顿

**解决方案**：
- 使用 QTimer 实现防抖
- 设置 100ms 延迟
- 只在停止拖动后应用更改

### 3. 热键冲突

**难点**：热键可能与其他程序冲突

**解决方案**：
- 提供热键自定义功能
- 捕获注册失败异常
- 提示用户更换热键

### 4. 资源路径

**难点**：打包后资源文件路径变化

**解决方案**：
- 使用 `sys._MEIPASS` 获取临时目录
- 封装 `get_resource_path()` 函数
- 统一资源访问方式

### 5. 程序退出

**难点**：确保退出时恢复默认设置

**解决方案**：
- 在 `quit_application()` 中调用 `reset_to_default()`
- 使用 `try-finally` 确保执行
- 注销所有热键

---

## 开发建议

### 1. 开发顺序

建议按以下顺序开发，确保每个阶段都能独立测试：

1. **Gamma 引擎** → 编写测试脚本验证功能
2. **配置管理器** → 测试配置读写
3. **主窗口** → 测试界面和引擎交互
4. **热键管理器** → 测试热键响应
5. **系统托盘** → 测试托盘菜单
6. **主程序** → 集成所有模块
7. **打包测试** → 测试可执行文件

### 2. 测试要点

- **功能测试**：每个模块的核心功能
- **集成测试**：模块间的交互
- **UI 测试**：界面响应和显示
- **性能测试**：资源占用和响应速度
- **兼容性测试**：Windows 10/11

### 3. 代码规范

- 使用类型注解（Type Hints）
- 编写文档字符串（Docstrings）
- 遵循 PEP 8 代码风格
- 使用有意义的变量名
- 适当的异常处理

### 4. 性能优化

- 缓存计算结果
- 使用防抖和节流
- 及时释放系统资源
- 避免不必要的 UI 更新

---

## 常见问题

### Q: 为什么选择 PyQt5 而不是 Tkinter？

A: PyQt5 提供更现代化的界面、更好的样式定制能力和更丰富的组件。

### Q: 能否支持多显示器独立调节？

A: 当前版本统一调节所有显示器。多显示器支持需要枚举显示设备，计划在后续版本实现。

### Q: 打包后体积较大怎么办？

A: 使用 UPX 压缩、排除不必要的模块、使用虚拟环境避免打包无关依赖。

### Q: 如何调试打包后的程序？

A: 在 `build.spec` 中设置 `console=True` 查看控制台输出，或查看日志文件。

---

## 参考资源

- **PyQt5 文档**: https://doc.qt.io/qtforpython/
- **Windows GDI32 API**: https://docs.microsoft.com/en-us/windows/win32/api/wingdi/
- **keyboard 库**: https://github.com/boppreh/keyboard
- **PyInstaller 文档**: https://pyinstaller.org/

---

## 总结

本项目的核心是 Gamma 调节引擎，其他模块都是围绕它构建的。建议先实现核心功能并充分测试，再逐步添加界面和扩展功能。保持代码简洁、模块化，便于后续维护和扩展。
